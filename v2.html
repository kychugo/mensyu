<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文樞</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #7fb3d5;
--secondary-color: #a2d9ce;
--accent-color: #a9cce3;
--highlight-color: #7dcea0;
--soft-color: #76d7c4;
--light-accent: #aed6f1;
--background-color: #f8fafa;
--text-color: #2c3e50;
--light-color: #ffffff;
--dark-color: #34495e;
--error-color: #e74c3c;
--hidden-bg: #ecf0f1;
--shadow-light: 0 2px 12px rgba(127, 179, 213, 0.15);
--shadow-medium: 0 4px 24px rgba(127, 179, 213, 0.2);
--shadow-heavy: 0 8px 36px rgba(127, 179, 213, 0.25);
--gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
--gradient-accent: linear-gradient(135deg, var(--highlight-color), var(--soft-color));
--border-radius: 12px;
--border-radius-small: 6px;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
background: linear-gradient(to bottom right, #f8fafa 0%, #f0f8ff 100%);
color: var(--text-color);
line-height: 1.6;
padding: 20px;
min-height: 100vh;
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
display: grid;
grid-template-columns: 1fr 2fr;
gap: 30px;
}

.copyright-footer {
position: fixed;
bottom: 0;
right: 0;
padding: 5px 10px;
background-color: #f1f1f1;
}

.copyright-footer p {
margin: 0;
font-size: 14px;
}

/* 響應式設計 */
@media (max-width: 1024px) {
.container {
grid-template-columns: 1fr;
width: 90%;
margin: 0 auto;
}
}

@media (max-width: 768px) {
.container {
width: 90%;
padding: 10px;
}

body {
padding: 10px;
}

.copyright-footer p {
font-size: 12px;
}
}

header {
text-align: center;
margin-bottom: 40px;
padding: 40px 20px;
background: var(--gradient-primary);
color: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-medium);
position: relative;
overflow: hidden;
grid-column: 1 / -1;
}

header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
pointer-events: none;
}

h1 {
margin-bottom: 15px;
font-size: clamp(2rem, 4vw, 3rem);
font-weight: 300;
letter-spacing: 3px;
font-family: 'Noto Serif TC', serif;
position: relative;
z-index: 1;
}

.input-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 1;
position: sticky;
top: 20px;
height: fit-content;
}

@media (max-width: 1024px) {
.input-section {
position: static;
}
}

@media (max-width: 768px) {
.input-section {
padding: 20px;
}
}

.input-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}

.input-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}

.section-title {
color: var(--primary-color);
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid var(--light-accent);
font-size: 1.4rem;
font-weight: 500;
font-family: 'Noto Serif TC', serif;
display: flex;
align-items: center;
gap: 10px;
}

.section-title::before {
content: '';
width: 8px;
height: 8px;
background: var(--secondary-color);
border-radius: 50%;
}

textarea {
width: 100%;
min-height: 400px;
padding: 20px;
border: 2px solid var(--light-accent);
border-radius: var(--border-radius-small);
resize: vertical;
font-size: 18px;
line-height: 1.8;
transition: var(--transition);
background: linear-gradient(to bottom, #fafafa, #ffffff);
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 768px) {
textarea {
min-height: 300px;
font-size: 16px;
padding: 15px;
}
}

textarea:focus {
outline: none;
border-color: var(--primary-color);
background: var(--light-color);
box-shadow: 0 0 0 4px rgba(127, 179, 213, 0.1);
}

.button-group {
display: flex;
gap: 15px;
margin-top: 25px;
flex-wrap: wrap;
}

button {
padding: 14px 28px;
background: var(--gradient-primary);
color: var(--light-color);
border: none;
border-radius: var(--border-radius-small);
cursor: pointer;
font-size: 16px;
font-weight: 500;
transition: var(--transition);
flex: 1;
min-width: 130px;
box-shadow: var(--shadow-light);
position: relative;
overflow: hidden;
}

@media (max-width: 768px) {
button {
padding: 12px 20px;
font-size: 14px;
min-width: 100px;
}
}

button::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: left 0.5s;
}

button:hover::before {
left: 100%;
}

button:hover {
transform: translateY(-3px);
box-shadow: var(--shadow-medium);
}

button:active {
transform: translateY(-1px);
}

button:disabled {
background: #bdc3c7;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.clear-btn {
background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.reveal-all-btn {
background: linear-gradient(135deg, #f39c12, #e67e22);
margin-top: 20px;
width: 100%;
}

.output-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 2;
}

@media (max-width: 1024px) {
.output-section {
grid-column: 1;
}
}

@media (max-width: 768px) {
.output-section {
padding: 20px;
}
}

.output-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}

.output-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}

.output-content {
min-height: 200px;
padding: 25px;
border: 2px solid var(--light-accent);
border-radius: var(--border-radius-small);
background: linear-gradient(to bottom, #fafafa, #ffffff);
}

@media (max-width: 768px) {
.output-content {
padding: 15px;
}
}

.loading {
display: none;
text-align: center;
padding: 50px;
color: var(--primary-color);
}

.spinner {
border: 4px solid rgba(127, 179, 213, 0.2);
border-radius: 50%;
border-top: 4px solid var(--primary-color);
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.error-message {
color: var(--error-color);
margin-top: 20px;
display: none;
padding: 15px;
background: #fadbd8;
border: 2px solid #f1948a;
border-radius: var(--border-radius-small);
}

.translation-block {
margin-bottom: 35px;
border-bottom: 2px dashed var(--light-accent);
padding-bottom: 25px;
}

.translation-block:last-child {
border-bottom: none;
}

.original-title, .translation-title {
font-weight: 600;
color: var(--primary-color);
margin-bottom: 15px;
font-size: 1.3rem;
font-family: 'Noto Serif TC', serif;
}

.original-text {
font-size: 18px;
line-height: 2;
margin-bottom: 25px;
padding: 20px;
background: linear-gradient(135deg, var(--light-accent), rgba(173, 214, 241, 0.3));
border-left: 5px solid var(--primary-color);
border-radius: var(--border-radius-small);
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 768px) {
.original-text {
font-size: 16px;
padding: 15px;
}
}

.translation-text {
background: linear-gradient(135deg, rgba(162, 217, 206, 0.2), rgba(118, 215, 196, 0.1));
padding: 20px;
border-radius: var(--border-radius-small);
line-height: 1.8;
font-size: 16px;
border-left: 5px solid var(--secondary-color);
}

@media (max-width: 768px) {
.translation-text {
padding: 15px;
font-size: 14px;
}
}

.character-breakdown {
margin-top: 20px;
padding: 20px;
background: linear-gradient(135deg, rgba(169, 204, 227, 0.2), rgba(125, 206, 160, 0.1));
border-radius: var(--border-radius-small);
font-size: 15px;
border-left: 5px solid var(--highlight-color);
}

@media (max-width: 768px) {
.character-breakdown {
padding: 15px;
font-size: 14px;
}
}

.character-item {
margin-bottom: 12px;
display: flex;
align-items: flex-start;
padding: 8px 0;
border-bottom: 1px solid rgba(127, 179, 213, 0.1);
}

.character-item:last-child {
border-bottom: none;
}

/* 懸浮式原文顯示 - 只在電腦版使用 */
.floating-original {
display: none;
position: fixed;
background: var(--light-color);
border: 2px solid var(--primary-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-heavy);
z-index: 1000;
}

/* 電腦版懸浮窗 */
@media (min-width: 1025px) {
.floating-original {
top: 50%;
right: 20px;
transform: translateY(-50%);
width: 350px;
max-height: 70vh;
overflow-y: auto;
}
}

/* 手機版懸浮窗 - 可調整高度 */
@media (max-width: 768px) {
.floating-original {
top: 0;
left: 0;
right: 0;
width: 100%;
max-width: none;
border-radius: 0 0 var(--border-radius) var(--border-radius);
border-top: none;
overflow: hidden;
min-height: 150px;
resize: vertical;
}

.floating-original.resizable {
height: 33.33vh;
}
}

.floating-original.show {
display: block;
animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(-50%) scale(0.9);
}
to {
opacity: 1;
transform: translateY(-50%) scale(1);
}
}

@media (max-width: 768px) {
@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(-20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
}

.floating-header {
background: var(--gradient-primary);
color: var(--light-color);
padding: 15px 20px;
display: flex;
justify-content: space-between;
align-items: center;
border-radius: var(--border-radius) var(--border-radius) 0 0;
}

@media (max-width: 768px) {
.floating-header {
border-radius: 0;
}
}

.floating-title {
font-weight: 600;
font-size: 1.1rem;
}

.floating-controls {
display: flex;
gap: 10px;
align-items: center;
}

.floating-toggle {
background: none;
border: none;
color: var(--light-color);
font-size: 1.2rem;
cursor: pointer;
padding: 5px;
border-radius: 50%;
transition: var(--transition);
width: 30px;
height: 30px;
display: flex;
align-items: center;
justify-content: center;
}

.floating-toggle:hover {
background: rgba(255, 255, 255, 0.2);
transform: scale(1.1);
}

.floating-content {
padding: 20px;
overflow-y: auto;
}

@media (max-width: 768px) {
.floating-content {
padding: 15px;
font-size: 16px;
height: calc(100% - 55px);
}
}

.floating-original-text {
font-size: 16px;
line-height: 1.8;
color: var(--text-color);
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 768px) {
.floating-original-text {
font-size: 17px;
line-height: 1.9;
}
}

/* 重新開啟按鈕 */
.reopen-floating {
position: fixed;
top: 20px;
right: 20px;
background: var(--gradient-primary);
color: var(--light-color);
border: none;
border-radius: 50%;
width: 50px;
height: 50px;
font-size: 1.2rem;
cursor: pointer;
box-shadow: var(--shadow-medium);
z-index: 999;
display: none;
transition: var(--transition);
}

.reopen-floating:hover {
transform: scale(1.1);
box-shadow: var(--shadow-heavy);
}

@media (max-width: 768px) {
.reopen-floating.show {
display: flex;
align-items: center;
justify-content: center;
}
}

.word-with-explanation {
position: relative;
display: inline;
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
margin: 0 2px;
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}

.word-with-explanation:hover {
background: rgba(127, 179, 213, 0.1);
}

.explanation-icon {
color: var(--secondary-color);
font-size: 0.9em;
margin-left: 4px;
cursor: pointer;
opacity: 0.8;
transition: var(--transition);
padding: 2px;
border-radius: 50%;
}

.explanation-icon:hover {
opacity: 1;
background: rgba(162, 217, 206, 0.3);
transform: scale(1.1);
}

.word-explanation {
display: none;
position: absolute;
bottom: 120%;
left: 50%;
transform: translateX(-50%);
background: var(--dark-color);
color: var(--light-color);
padding: 12px 16px;
border-radius: var(--border-radius-small);
font-size: 14px;
white-space: nowrap;
z-index: 1001;
box-shadow: var(--shadow-medium);
max-width: 300px;
white-space: normal;
}

.word-explanation::after {
content: '';
position: absolute;
top: 100%;
left: 50%;
transform: translateX(-50%);
border: 6px solid transparent;
border-top-color: var(--dark-color);
}

.word-explanation.show {
display: block;
animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateX(-50%) translateY(10px);
}
to {
opacity: 1;
transform: translateX(-50%) translateY(0);
}
}

.click-to-reveal {
position: relative;
cursor: pointer;
margin: 0 2px;
display: inline-block;
transition: var(--transition);
}

.hidden-text {
background: var(--hidden-bg);
color: transparent;
border-radius: 4px;
padding: 4px 8px;
transition: var(--transition);
user-select: none;
position: relative;
}

.hidden-text::before {
content: '點擊顯示';
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
color: var(--primary-color);
font-size: 12px;
opacity: 0.7;
pointer-events: none;
}

.hidden-text:hover {
background: rgba(127, 179, 213, 0.2);
}

.hidden-text.revealed {
background: transparent;
color: inherit;
}

.hidden-text.revealed::before {
display: none;
}

.sentence-container {
margin-bottom: 15px;
}

.character {
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}

.character:hover {
background: rgba(127, 179, 213, 0.1);
}

.explanation {
display: none;
padding-left: 20px;
color: var(--dark-color);
font-style: italic;
margin-top: 8px;
border-left: 3px solid var(--secondary-color);
padding: 8px 0 8px 15px;
}

.explanation.revealed {
display: block;
animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
from {
opacity: 0;
max-height: 0;
}
to {
opacity: 1;
max-height: 100px;
}
}

.common-word {
background: linear-gradient(135deg, rgba(127, 179, 213, 0.2), rgba(162, 217, 206, 0.2));
padding: 2px 6px;
border-radius: 4px;
font-weight: 600;
}

/* 手機版高度調整手柄 */
@media (max-width: 768px) {
.floating-original::after {
content: '';
position: absolute;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 50px;
height: 5px;
background: var(--primary-color);
border-radius: 3px 3px 0 0;
cursor: ns-resize;
}
}

::-webkit-scrollbar {
width: 10px;
}

::-webkit-scrollbar-track {
background: rgba(127, 179, 213, 0.1);
border-radius: 5px;
}

::-webkit-scrollbar-thumb {
background: var(--primary-color);
border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
background: var(--secondary-color);
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>文樞</h1>
</header>

<div class="input-section">
<h2 class="section-title">輸入文言文</h2>
<textarea id="classical-text" placeholder="請在此輸入文言文篇章內容..."></textarea>
<div class="button-group">
<button id="translate-btn">
<i class="fas fa-language"></i> 翻譯
</button>
<button id="clear-btn" class="clear-btn">
<i class="fas fa-eraser"></i> 清除
</button>
</div>
<div class="error-message" id="error-message"></div>
</div>

<div class="output-section">
<h2 class="section-title">翻譯結果</h2>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>正在翻譯中，請稍候...</p>
</div>
<div class="output-content" id="translation-result"></div>
<button id="reveal-all-btn" class="reveal-all-btn">
<i class="fas fa-eye"></i> 顯示全部解釋
</button>
</div>

<footer>
<div class="copyright-footer">
<p>Copyright © 2025 黃子謙、陳冠健. All rights reserved</p>
</div>
</footer>
</div>

<!-- 懸浮式原文顯示 -->
<div id="floating-original" class="floating-original resizable">
<div class="floating-header">
<div class="floating-title">原文</div>
<div class="floating-controls">
<button id="floating-toggle" class="floating-toggle" title="關閉懸浮窗">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="floating-content">
<div id="floating-original-text" class="floating-original-text"></div>
</div>
</div>

<!-- 重新開啟懸浮窗按鈕 -->
<button id="reopen-floating" class="reopen-floating" title="開啟原文懸浮窗">
<i class="fas fa-scroll"></i>
</button>

<script>
// API 配置信息
const API_KEYS = [
"sk-MoqwsgO8P9MEoCrftvdSYA"
];
let currentApiKeyIndex = 0;
const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
const MODEL = "DeepSeek-R1-0528";

// 懸浮窗狀態管理
let isFloatingEnabled = true;
let currentOriginalTexts = [];

document.addEventListener('DOMContentLoaded', function() {
const translateBtn = document.getElementById('translate-btn');
const clearBtn = document.getElementById('clear-btn');
const revealAllBtn = document.getElementById('reveal-all-btn');
const classicalText = document.getElementById('classical-text');
const translationResult = document.getElementById('translation-result');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('error-message');
const floatingOriginal = document.getElementById('floating-original');
const floatingToggle = document.getElementById('floating-toggle');
const floatingOriginalText = document.getElementById('floating-original-text');
const reopenFloating = document.getElementById('reopen-floating');

// 檢測設備類型
function getDeviceType() {
const width = window.innerWidth;
if (width <= 768) return 'mobile';
if (width <= 1024) return 'tablet';
return 'desktop';
}

// 初始化懸浮窗狀態
function initFloatingWindow() {
    const deviceType = getDeviceType();
    if (deviceType === 'mobile') {
        // 手機：根據 localStorage 初始化懸浮窗狀態
        isFloatingEnabled = localStorage.getItem('floatingEnabled') !== 'false';
        updateFloatingToggleIcon();
        updateReopenButton();
    } else {
        // 平板和電腦：禁用懸浮窗
        isFloatingEnabled = false;
        reopenFloating.style.display = 'none';
    }
}

// 更新懸浮窗切換按鈕圖示
function updateFloatingToggleIcon() {
const icon = floatingToggle.querySelector('i');
if (isFloatingEnabled) {
icon.className = 'fas fa-times';
floatingToggle.title = '關閉懸浮窗';
} else {
icon.className = 'fas fa-expand';
floatingToggle.title = '開啟懸浮窗';
}
}

// 更新重新開啟按鈕顯示狀態
function updateReopenButton() {
const deviceType = getDeviceType();
if (deviceType === 'mobile') {
if (!isFloatingEnabled && currentOriginalTexts.length > 0) {
reopenFloating.classList.add('show');
} else {
reopenFloating.classList.remove('show');
}
}
}

// 顯示懸浮式原文
function showFloatingOriginal() {
    const deviceType = getDeviceType();
    if (deviceType !== 'mobile' || !isFloatingEnabled) {
        return;
    }
    if (currentOriginalTexts.length > 0) {
        const combinedText = currentOriginalTexts.join('<br><br>');
        floatingOriginalText.innerHTML = combinedText;
        floatingOriginal.classList.add('show');
        updateReopenButton();
    }
}

// 隱藏懸浮式原文
function hideFloatingOriginal() {
floatingOriginal.classList.remove('show');
updateReopenButton();
}

// 懸浮窗切換功能
floatingToggle.addEventListener('click', function() {
const deviceType = getDeviceType();

if (deviceType === 'mobile') {
isFloatingEnabled = !isFloatingEnabled;
localStorage.setItem('floatingEnabled', isFloatingEnabled);
updateFloatingToggleIcon();

if (isFloatingEnabled && currentOriginalTexts.length > 0) {
showFloatingOriginal();
} else {
hideFloatingOriginal();
}
} else {
// 電腦版直接關閉
hideFloatingOriginal();
}
});

// 重新開啟懸浮窗按鈕
reopenFloating.addEventListener('click', function() {
isFloatingEnabled = true;
localStorage.setItem('floatingEnabled', true);
updateFloatingToggleIcon();
showFloatingOriginal();
});

// 手機版懸浮窗可調整高度
let isResizing = false;
let startY = 0;
let startHeight = 0;

if (getDeviceType() === 'mobile') {
floatingOriginal.addEventListener('mousedown', startResize);
floatingOriginal.addEventListener('touchstart', startResize);
}

function startResize(e) {
const deviceType = getDeviceType();
if (deviceType !== 'mobile') return;

const target = e.target;
if (target === floatingOriginal || target.closest('.floating-original')) {
const rect = floatingOriginal.getBoundingClientRect();
const isNearBottom = (e.clientY || e.touches[0].clientY) > rect.bottom - 20;

if (isNearBottom) {
isResizing = true;
startY = e.clientY || e.touches[0].clientY;
startHeight = floatingOriginal.offsetHeight;

document.addEventListener('mousemove', resize);
document.addEventListener('touchmove', resize);
document.addEventListener('mouseup', stopResize);
document.addEventListener('touchend', stopResize);

e.preventDefault();
}
}
}

function resize(e) {
if (!isResizing) return;

const currentY = e.clientY || e.touches[0].clientY;
const newHeight = startHeight + (currentY - startY);
const minHeight = 150;
const maxHeight = window.innerHeight * 0.8;

if (newHeight >= minHeight && newHeight <= maxHeight) {
floatingOriginal.style.height = newHeight + 'px';
}
}

function stopResize() {
isResizing = false;
document.removeEventListener('mousemove', resize);
document.removeEventListener('touchmove', resize);
document.removeEventListener('mouseup', stopResize);
document.removeEventListener('touchend', stopResize);
}

// 視窗大小改變時重新檢查設備類型
window.addEventListener('resize', function() {
initFloatingWindow();
if (currentOriginalTexts.length > 0) {
showFloatingOriginal();
}
});

// 翻譯按鈕點擊事件
translateBtn.addEventListener('click', function() {
const text = classicalText.value.trim();

if (!text) {
showError('請輸入文言文內容');
return;
}

translateText(text);
});

// 清除按鈕點擊事件
clearBtn.addEventListener('click', function() {
classicalText.value = '';
translationResult.innerHTML = '';
currentOriginalTexts = [];
hideFloatingOriginal();
hideError();
});

// 顯示全部解釋按鈕
revealAllBtn.addEventListener('click', function() {
const hiddenElements = document.querySelectorAll('.hidden-text');
hiddenElements.forEach(el => {
el.classList.add('revealed');
});

const explanations = document.querySelectorAll('.explanation');
explanations.forEach(el => {
el.classList.add('revealed');
});
});

// 顯示錯誤訊息
function showError(message) {
errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
errorMessage.style.display = 'block';
}

// 隱藏錯誤訊息
function hideError() {
errorMessage.style.display = 'none';
}

// 翻譯文本
async function translateText(text) {
try {
// 顯示載入中
loading.style.display = 'block';
translationResult.innerHTML = '';
hideError();

// 禁用按鈕
translateBtn.disabled = true;

// 構建提示詞
const prompt = `請將以下文言文逐字翻譯並解釋(直譯，不要意譯)，格式要求：

原文：
[顯示原文句子]

語譯：
[顯示完整句子翻譯]

逐字解釋：
[對每個文字進行解釋，格式為"字：解釋"，常見文言字詞用**粗體**標示，切勿解釋標點符號]

要求：
1. 為每一句(以，。？!：； 作為分隔)進行語譯
2. 如果該行有常見文言字詞，請為該字及其詞解粗體
3. 用中文繁體字顯示所有內容
4. 不要提供思考過程，用<think></think>中間內容
5. 保持嚴格的格式，使用標題和清晰的分段
6. 不要在任何地方使用多餘的星號(*)
7. 不要使用任何裝飾性符號或分隔線
8. 確保每部分都有明確的標題（原文、語譯、逐字解釋）
9. 逐字解釋只解釋文字字符，不解釋標點符號如，。？!等

需要翻譯的文言文：
${text}`;

// 調用API
const response = await callTranslateAPI(prompt);

// 處理回應
if (response && response.choices && response.choices[0].message.content) {
const translatedText = response.choices[0].message.content;
displayFormattedResult(translatedText);
} else {
showError('翻譯失敗，請稍後再試');
}
} catch (error) {
console.error('翻譯錯誤:', error);
showError('翻譯過程中發生錯誤: ' + error.message);
} finally {
// 隱藏載入中，啟用按鈕
loading.style.display = 'none';
translateBtn.disabled = false;
}
}

// 調用翻譯API
async function callTranslateAPI(prompt) {
const apiKey = API_KEYS[currentApiKeyIndex];

try {
const response = await fetch(API_URL, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${apiKey}`
},
body: JSON.stringify({
model: MODEL,
messages: [
{
role: "user",
content: prompt
}
],
temperature: 0.3,
max_tokens: 64000
})
});

if (!response.ok) {
throw new Error(`API 請求失敗: ${response.status}`);
}

return await response.json();
} catch (error) {
console.error('API 調用錯誤:', error);
// 嘗試下一個API密鑰
currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
if (currentApiKeyIndex === 0) {
throw new Error('所有API密鑰嘗試失敗');
}
return callTranslateAPI(prompt);
}
}

// 顯示格式化後的結果
function displayFormattedResult(text) {
// 移除<think>標籤內容
text = text.replace(/<think>.*?<\/think>/gs, '');

// 清理文本格式
text = cleanTextFormatting(text);

// 分割不同的翻譯塊
const blocks = splitTranslationBlocks(text);
let htmlOutput = '';
currentOriginalTexts = []; // 重置原文陣列

for (let i = 0; i < blocks.length; i++) {
const block = blocks[i];

if (block.type === 'original') {
const formattedOriginal = formatOriginalText(block.content);
currentOriginalTexts.push(formattedOriginal); // 收集原文
htmlOutput += `<div class="translation-block">
<div class="original-title"><i class="fas fa-scroll"></i> 原文</div>
<div class="original-text">${formattedOriginal}</div>`;
} 
else if (block.type === 'translation') {
htmlOutput += `<div class="translation-title"><i class="fas fa-language"></i> 語譯</div>
<div class="translation-text">${formatTranslationText(block.content)}</div>`;
}
else if (block.type === 'breakdown') {
htmlOutput += `<div class="character-breakdown"><strong><i class="fas fa-search"></i> 逐字解釋</strong>${formatCharacterBreakdown(block.content)}</div>
</div>`;
}
}

translationResult.innerHTML = htmlOutput;
setupClickToReveal();
setupWordExplanations();

// 顯示懸浮式原文（如果有翻譯結果且功能已啟用）
if (currentOriginalTexts.length > 0) {
showFloatingOriginal();
}
}

// 設置詞解功能
function setupWordExplanations() {
const commonWords = document.querySelectorAll('.common-word');
commonWords.forEach(word => {
// 檢查是否為單個文字字符（排除標點符號）
const text = word.textContent.trim();
if (text.length === 1 && /[\u4e00-\u9fff]/.test(text)) {
word.classList.add('word-with-explanation');

// 添加詞解顯示
const explanation = document.createElement('span');
explanation.className = 'word-explanation';
explanation.textContent = `常見`;
word.appendChild(explanation);

// 設置點擊顯示詞解
word.addEventListener('click', function() {
const explanationSpan = this.querySelector('.word-explanation');
if (explanationSpan) {
explanationSpan.classList.toggle('show');
// 隱藏其他詞解
commonWords.forEach(otherWord => {
if (otherWord !== this) {
const otherExplanation = otherWord.querySelector('.word-explanation');
if (otherExplanation) {
otherExplanation.classList.remove('show');
}
}
});
}
});
}
});

// 點擊其他地方隱藏詞解
document.addEventListener('click', function(e) {
if (!e.target.closest('.word-with-explanation')) {
const explanations = document.querySelectorAll('.word-explanation');
explanations.forEach(explanation => {
explanation.classList.remove('show');
});
}
});
}

// 設置點擊顯示功能
function setupClickToReveal() {
// 設置逐字解釋的點擊顯示
const characters = document.querySelectorAll('.character');
characters.forEach(character => {
character.addEventListener('click', function() {
const explanation = this.nextElementSibling;
if (explanation && explanation.classList.contains('explanation')) {
explanation.classList.toggle('revealed');
}
});
});

// 設置句子翻譯的點擊顯示
const translationTexts = document.querySelectorAll('.translation-text');
translationTexts.forEach(textDiv => {
const sentences = textDiv.innerHTML.split('<br>').filter(s => s.trim());
let newContent = '';

sentences.forEach(sentence => {
if (sentence.trim()) {
newContent += `
<div class="sentence-container">
<span class="hidden-text click-to-reveal">${sentence.trim()}</span>
</div>
`;
}
});

textDiv.innerHTML = newContent;

// 設置句子點擊顯示
const hiddenSentences = textDiv.querySelectorAll('.hidden-text');
hiddenSentences.forEach(sentence => {
sentence.addEventListener('click', function() {
this.classList.toggle('revealed');
});
});
});
}

// 分割翻譯區塊
function splitTranslationBlocks(text) {
const blocks = [];
const lines = text.split('\n');
let currentBlock = null;

for (let i = 0; i < lines.length; i++) {
const line = lines[i].trim();

if (line.startsWith('原文：') || line === '原文') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'original', content: '' };
const content = line.replace(/^原文：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (line.startsWith('語譯：') || line === '語譯') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'translation', content: '' };
const content = line.replace(/^語譯：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (line.startsWith('逐字解釋：') || line === '逐字解釋') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'breakdown', content: '' };
const content = line.replace(/^逐字解釋：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (currentBlock) {
currentBlock.content += line + '\n';
}
}

if (currentBlock) blocks.push(currentBlock);
return blocks;
}

// 清理文本格式
function cleanTextFormatting(text) {
// 移除多餘的星號行
text = text.replace(/^\*+\s*$/gm, '');

// 移除開頭和結尾的多餘星號
text = text.replace(/^\*+/, '').replace(/\*+$/, '');

// 合併多個空行
text = text.replace(/\n{3,}/g, '\n\n');

// 移除多餘的分隔線
text = text.replace(/^-{3,}\s*$/gm, '');

return text.trim();
}

// 格式化原文文本
function formatOriginalText(text) {
text = cleanSectionText(text);
return text.replace(/\n/g, '<br>')
.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');
}

// 格式化語譯文本
function formatTranslationText(text) {
text = cleanSectionText(text);
return text.replace(/\n/g, '<br>')
.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');
}

// 格式化逐字解釋
function formatCharacterBreakdown(text) {
text = cleanSectionText(text);

// 處理粗體標記
text = text.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');

// 分割成行
const lines = text.split('\n').filter(line => line.trim());
let html = '';

lines.forEach(line => {
// 清理每行的多餘星號
line = line.replace(/^\*+/, '').replace(/\*+$/, '').trim();

// 分割字和解釋
const parts = line.split(/:|：/);
if (parts.length >= 2) {
const character = parts[0].trim();
const explanation = parts.slice(1).join(':').trim();
// 只處理文字字符，排除標點符號
if (/[\u4e00-\u9fff]/.test(character)) {
html += `
<div class="character-item">
<span class="character">${character}</span>
<span class="explanation">：${explanation}</span>
</div>
`;
}
} else if (line.trim()) {
html += `<div>${line}</div>`;
}
});

return html;
}

// 清理區塊內文
function cleanSectionText(text) {
// 移除開頭和結尾的空白
text = text.trim();

// 移除開頭和結尾的冒號
text = text.replace(/^：+/, '').replace(/：+$/, '');

// 移除多餘的星號
text = text.replace(/^\*+/, '').replace(/\*+$/, '');

return text;
}

// 初始化
initFloatingWindow();
});

// 變數用於文件處理（保持原有功能）
var gk_isXlsx = false;
var gk_xlsxFileLookup = {};
var gk_fileData = {};

function filledCell(cell) {
return cell !== '' && cell != null;
}

function loadFileData(filename) {
if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
try {
var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
var firstSheetName = workbook.SheetNames[0];
var worksheet = workbook.Sheets[firstSheetName];

// Convert sheet to JSON to filter blank rows
var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
// Filter out blank rows (rows where all cells are empty, null, or undefined)
var filteredData = jsonData.filter(row => row.some(filledCell));

// Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
var headerRowIndex = filteredData.findIndex((row, index) =>
row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
);
// Fallback
if (headerRowIndex === -1 || headerRowIndex > 25) {
headerRowIndex = 0;
}

// Convert filtered JSON back to CSV
var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
return csv;
} catch (e) {
console.error(e);
return "";
}
}
return gk_fileData[filename] || "";
}
</script>
</body>
</html>
